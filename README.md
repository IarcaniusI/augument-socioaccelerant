# README

## /r/Pikabu

**Лига Киборгов** представляет:
Теперь у каждого имеется возможность стать человеческим организмом, усиленным робототехническими аугументациями и кибернетическими имплантами.

Робототехнические аугументации позволят ускорить рутиные операции взаимодействия с окружением, (например, теперь можно автоматически посылать в ответ любого пославшего), позволяя существенно ускорить собственные возможности.

Кибернетические имплантаты позволят произвести быстрый анализ окружения и сообщить необходимую информацию, без непосредственного взаимодействия с окружением (например, можно быстро узнать о концетрации посыланий в определённых местах, благодаря появлению соответствующих сообщений в личке, что позволит быстро присоединиться к вечеринке).

## Аугументация: социальный акселератор

В данном хранилище расположен социальный акселератор - аугументация, позволяющая отвечать на любые распространённые и приевшиеся вопросы и претензии, экономя силы и время для действительно важных холиваров.
Для аугументации указываются наборы выражений, при обнаружении которых в ответе носителю, производится ответ произвольной наиболее подходящий фразой.

## Эксплуатация

#### Windows

Необходимо скачать для Windows архив:
 - augument-socioaccelerant.zip

После разархивации в каталоге должен находиться:
 - ```augument-socioaccelerant.exe``` - выполняемый файл;
 - ```auth.conf``` - файл с настройками подключения;
 - ```run.conf``` - файл с настройками выражений и ответов на них;
 - ```praw.ini``` - файл с настройками Reddit-модуля (лучше не изменять).

Для запуска достаточно запустить ```.exe``` файл, с расположенными рядом и подстроенными ```auth.conf``` и ```run.conf```. Анализ сообщений производится только пока файл запущен. После изменения в файлах настроек необходимо выполнить перезапуск.

Для завершения процесса можно нажать комбинацию клавиш ```Ctrl```+```C```.

Далее, можно переходить к разделу [Настройка соединения](#настройка-соединения)

#### Linux, как бинарный файл

Необходимо скачать для Linux архив:
 - augument-socioaccelerant.tar.gz

После разархивации в каталоге должен находиться:
 - ```augument-socioaccelerant``` - выполняемый файл;
 - ```auth.conf``` - файл с настройками подключенияж
 - ```run.conf``` - файл с настройками выражений и ответов на нихж
 - ```praw.ini``` - файл с настройками Reddit-модуля (лучше не изменять).

Исполняемый файл ```augument-socioaccelerant``` имеет следующие аргументы командной строки:
 - ```-h```, ```--help``` - справка с описанием аргументов;
 - ```-r```, ```--run``` ```RUNFILE``` - путь до файла с настройками выражений (по умолчанию ```./run.conf```);
 - ```-a```, ```--auth``` ```AUTHFILE``` - путь до файла с настройками подключения (по умолчанию ```./auth.conf```);
 - ```-n```, ```--no-notify``` - отключить сообщения о событиях и ответах (например, для экономии места на диске для логов);

При запуске без аргументов конфигурационные файлы должны находиться рядом с бинарным. Анализ сообщений производится только пока файл запущен. После изменения в файлах настроек необходимо выполнить перезапуск.

Для завершения процесса можно нажать комбинацию клавиш ```Ctrl```+```C```.

Далее, можно переходить к разделу [Настройка соединения](#настройка-соединения)

#### Linux, как сервис для supervisord

Предварительно должны быть установлены пакеты:
 - [python3](https://www.python.org/)
 - [supervisor](http://supervisord.org/)

Требуется установить следующие модули для ```Python 3```:
 - ```praw```
 - ```prawcore```

Выкачиваем репозиторий, после чего раскладываем файлы следующим образом:
 - ```augument-socioaccelerant.py``` в каталог ```/usr/local/bin/```
 - ```run.conf``` и ```auth.conf``` в каталог ```/usr/local/etc/augument-socioaccelerant/```
 - ```augument-socioaccelerant.conf``` в каталог ```/etc/supervisor/conf.d/```

В описанном файле ```augument-socioaccelerant.conf``` предполагается запуск сервиса от пользователя ```cyborg```. 
Поэтому для успешной работы необходимо сделать одно из следующих действий:
 - создать в системе пользователя с именем ```cyborg```;
 - изменить в файле ```augument-socioaccelerant.conf``` значение переменной ```user``` на имя существующего пользователя.

Добавляем новообразовавшийся сервис путём выполнения следующих команд:
```
supervisorctl reread
supervisorctl add augument-socioaccelerant
```

Посмотреть на статус сервисов можно командой:
```
supervisorctl status
```

Произвести запуск, остановку и перезапуск сервиса для пересчитывания конфигов можно с помошью следующих команд:
```
supervisorctl start augument-socioaccelerant
supervisorctl stop augument-socioaccelerant
supervisorctl restart augument-socioaccelerant
```

Логи будут писаться через ```rsyslog```, как правило это делается в файл ```/var/log/syslog```.

Далее, можно переходить к разделу [Настройка соединения](#настройка-соединения)

## Настройка соединения

Сперва необходимо дать Reddit сгенерировать ключ. Для этого требуется:
1. Зайти в свой аккаунт на Reddit и перейти по ссылке [www.reddit.com/prefs/apps](https://www.reddit.com/prefs/apps);
1. Нажать кнопку ```Create another app...``` (```Создать другое приложение...```);
1. В поле ```name``` (```имя```) вбить название, к примеру ```auguments-and-implants```;
1. Выбрать переключатель ```script``` (```сценарий```);
1. В поле ```redirect uri``` (```uri переадресации```) вбить ссылку для перенаправления, например [www.example.com/unused/redirect/uri](http://www.example.com/unused/redirect/uri);
1. По желанию заполнить поля ```description``` (```описание```) и ```about url``` (```о url```);
1. Нажать кнопку ```create app``` (```создать приложение```);
1. Из появившейся карточки необходимо скопировать:
    - ID, расположенный под надписью ```personal use script``` (```скрипт для личного пользования```);
    - секретный ключ, расположенный рядом с надписью ```secret``` (```секрет```).

После того как данная последовательность действий выполнена, полученными настройками можно пользоваться и для других обработчиков.

Теперь необходимо занести соответствующие настройки в ```auth.conf``` файл. Пример файла:
```
{
    "user_agent": "augument-socioaccelerant (/u/myuser)",
    "client_id": "braEnm4E3V9D01",
    "client_secret": "3F9dfp2_CspmeVd81Dkepvnwl3D",
    "username": "myuser",
    "password": "mypassword",
    "subreddit": "Pikabu"
}
```
Здесь в настройках указывается:
 - ```user_agent``` - общее имя программы и имя пользователя;
 - ```client_id``` - ID, скопированный ранне;
 - ```client_secret``` - секретный ключ, скопированный ранее;
 - ```username``` - имя пользователя;
 - ```password``` - пароль, для входа в аккаунт;
 - ```subreddit``` - название саба, к которому происходит подключение;

## Составление правил

Правила описываются в файле ```run.conf```. Рассмотреть составление правил можно на следующем примере:
```
[
    {
        "verified_user": "myuser",
        "reply_regexes": ["(Пошёл|пшёл|иди)", "(отсюда|от сюда|отсюдова)"],
        "answers": ["Сам катись отсюда"]
    },
    {
        "verified_user": "myuser",
        "reply_regexes": ["(пошли бы|пойти бы)", "(вы|вам)", "(сударь|месье)"],
        "answers": ["Тогда я вас вынужден послать, сударь.", "Не хотите ли вы сами отправиться?"]
    }
]
```

В примере присутствуют 2 правила, заключённых в фигурные скобки.
У каждого правила присутствует параметр ```verified_user```, показывающий, ответы какому пользователю необходимо анализировать.
Как правило, это имя пользователя аккаунта.
```
В случае если имя пользователя не указывается, а вместо этого передаётся пустая строка, производится анализ ответов ВСЕМ пользователям.
Этим режимом нужно пользоваться с осторожностью, так как можно случайно вызвать нежелательный спам.
```

Параметр ```reply_regexes``` хранит список фраз, которые должны быть найденны в комментарии, чтобы на него был дан ответ.
Порядок фраз не важен, поэтому в данном примере предложения "пошёл отсюдова" и "отсюдова пошёл" одинаково подходят.
Однако если в коменте не встречается хотя бы одна из фраз (например, как в комменте "пошёл вон быстро", где отсутствует "отсюда"), коммент считается не подходящим по данному правилу.

Должны быть обнаружены все описанные в правиле фразы именно в сформулированном виде, поэтому предложения "сударь, пошли бы вы отсюда" и "сударь, пойти бы вы сюда" подходят - в них присутствуют
фразы "сударь", "пошли бы" или "пойти бы" и "вы".
В то время как предложение "пошли ка вы бы сударь" не подходит, так как отсутствует фраза "пошли бы" или "пойти бы".

В списке ```answers``` необходимо указывать ответ, который всегда будет выбираться при обнаружении искомых фраз.
В случае если в списке ```answers``` несколько ответов, то каждый раз из них выбирается один случайным образом. 

В ```reply_regexes``` можно использовать регулярные выражении.
При использовании регулярных выражений экранирование должно выполяться двойным обратным слешем ```\\```, а не одинарным.

## Разработчикам

### Компиляция

Для компиляции необходимо установить модули для ```Python3```:
 - ```pyinstaller```

Для сборки выполняем команду:
```
pyinstaller ./augument-socioaccelerant.py --onefile
```

Бинарный файл будет распологаться в новосозданном каталоге ```dist```.
После сборки можно удалить как ненужные следующие объекты:
- каталог ```__pycache__```;
- каталог ```build```;
- каталог ```dist```;
- файлы с расширением ```.spec```.

Рядом с получившимся бинарным файлом необходимо рядом положить файл ```praw.ini```, поставляемый вместе с модулем ```praw```.
